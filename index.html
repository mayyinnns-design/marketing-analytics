<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥é”€æ´»åŠ¨æ•°æ®åˆ†æå¹³å° V2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }

        .upload-box {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-box:hover {
            background: #f8f9ff;
            border-color: #764ba2;
        }

        .upload-box h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .upload-box p {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 4px;
            font-size: 14px;
            color: #2e7d32;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .error {
            background: #ffebee;
            color: #c62828;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 10px;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
        }

        .analysis-section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .analysis-section.show {
            display: block;
        }

        .result-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .result-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9ff;
        }

        /* æ™ºèƒ½é—®ç­”æ ·å¼ */
        .qa-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: none;
        }

        .qa-section.show {
            display: block;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }

        .search-input:focus {
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .qa-examples {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .example-tag {
            padding: 8px 15px;
            background: #f0f0f0;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .example-tag:hover {
            background: #667eea;
            color: white;
        }

        .qa-result {
            padding: 20px;
            background: #f8f9ff;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: none;
        }

        .qa-result.show {
            display: block;
        }

        .qa-result h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .qa-answer {
            color: #555;
            line-height: 1.8;
        }

        .qa-data {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š è¥é”€æ´»åŠ¨æ•°æ®åˆ†æå¹³å°</h1>
            <p style="color: #666; margin-top: 10px;">åˆ†åˆ«ä¸Šä¼ ä¸¤ç±»æ•°æ®ï¼Œè·å–ä¸“ä¸šçš„è¥é”€åˆ†ææŠ¥å‘Š</p>
        </div>

        <div class="upload-section">
            <h2 style="margin-bottom: 20px; color: #333;">ğŸ“ æ•°æ®ä¸Šä¼ </h2>
            
            <div class="upload-grid">
                <!-- å…¬å¸è´­ä¹°æ˜ç»†ä¸Šä¼  -->
                <div class="upload-box" onclick="document.getElementById('purchaseFile').click()">
                    <div class="upload-icon">ğŸ“‹</div>
                    <h3>å…¬å¸è´­ä¹°æ˜ç»†</h3>
                    <p>åŒ…å«å­—æ®µï¼šæ´»åŠ¨åç§°ã€å…¬å¸åç§°ã€äº§å“åç§°ã€<br>åˆåŒè®¢å•é‡‘é¢ã€æ–°è´­é‡‘é¢ã€æ–°å®¢æˆ·é‡‘é¢</p>
                    <input type="file" id="purchaseFile" accept=".csv,.xlsx,.xls">
                    <div id="purchaseInfo" class="file-info"></div>
                </div>

                <!-- æ´»åŠ¨çº¿ç´¢æ•°æ®ä¸Šä¼  -->
                <div class="upload-box" onclick="document.getElementById('leadFile').click()">
                    <div class="upload-icon">ğŸ“Š</div>
                    <h3>æ´»åŠ¨çº¿ç´¢æ•°æ®</h3>
                    <p>åŒ…å«å­—æ®µï¼šæ´»åŠ¨åç§°ã€çº¿ç´¢æ•°ã€è§¦è¾¾ä¼ä¸šæ•°ã€<br>è½¬åŒ–ç‡ã€è®¢å•é‡‘é¢ã€æ–°è´­è½¬åŒ–ç‡</p>
                    <input type="file" id="leadFile" accept=".csv,.xlsx,.xls">
                    <div id="leadInfo" class="file-info"></div>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="btn" id="analyzeBtn" disabled>ğŸš€ å¼€å§‹åˆ†æ</button>
            </div>

            <div id="uploadStatus"></div>
        </div>

        <!-- æ™ºèƒ½é—®ç­”åŒºåŸŸ -->
        <div id="qaSection" class="qa-section">
            <h2 style="margin-bottom: 20px;">ğŸ¤– æ™ºèƒ½é—®ç­”</h2>
            <p style="color: #666; margin-bottom: 20px;">åŸºäºå·²ä¸Šä¼ çš„æ•°æ®ï¼Œæ‚¨å¯ä»¥ç”¨è‡ªç„¶è¯­è¨€æé—®ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†æå¹¶å›ç­”</p>
            
            <div class="search-box">
                <input type="text" id="qaInput" class="search-input" placeholder="ä¾‹å¦‚ï¼šè…¾è®¯ç§‘æŠ€å‚åŠ äº†å“ªäº›æ´»åŠ¨ï¼Ÿæ–°å¹´è¥é”€å³°ä¼šè§¦è¾¾äº†å“ªäº›å…¬å¸ï¼Ÿå“ªäº›å…¬å¸è´­ä¹°äº†ä¼ä¸šç‰ˆCRMï¼Ÿ">
                <button class="search-btn" id="qaBtn">ğŸ” æé—®</button>
            </div>

            <div class="qa-examples">
                <span style="color: #666; font-size: 14px; margin-right: 10px;">ğŸ’¡ å¸¸è§é—®é¢˜ï¼š</span>
                <div class="example-tag" data-q="è…¾è®¯ç§‘æŠ€è´­ä¹°äº†å“ªäº›äº§å“">è…¾è®¯ç§‘æŠ€è´­ä¹°äº†å“ªäº›äº§å“ï¼Ÿ</div>
                <div class="example-tag" data-q="ä¼ä¸šç‰ˆCRMè¢«å“ªäº›å…¬å¸è´­ä¹°">ä¼ä¸šç‰ˆCRMè¢«å“ªäº›å…¬å¸è´­ä¹°ï¼Ÿ</div>
                <div class="example-tag" data-q="æ–°å¹´è¥é”€å³°ä¼šæœ‰å“ªäº›å…¬å¸è´­ä¹°">æ–°å¹´è¥é”€å³°ä¼šæœ‰å“ªäº›å…¬å¸è´­ä¹°ï¼Ÿ</div>
                <div class="example-tag" data-q="æ–°å¹´è¥é”€å³°ä¼šæœ‰å“ªäº›äº§å“è¢«è´­ä¹°">æ–°å¹´è¥é”€å³°ä¼šæœ‰å“ªäº›äº§å“è¢«è´­ä¹°ï¼Ÿ</div>
                <div class="example-tag" data-q="è…¾è®¯ç§‘æŠ€å‚åŠ äº†å“ªäº›æ´»åŠ¨">è…¾è®¯ç§‘æŠ€å‚åŠ äº†å“ªäº›æ´»åŠ¨ï¼Ÿ</div>
                <div class="example-tag" data-q="å“ªä¸ªå…¬å¸è´­ä¹°é‡‘é¢æœ€é«˜">å“ªä¸ªå…¬å¸è´­ä¹°é‡‘é¢æœ€é«˜ï¼Ÿ</div>
            </div>

            <div id="qaResult" class="qa-result"></div>
        </div>

        <div id="analysisSection" class="analysis-section">
            <h2 style="margin-bottom: 20px;">ğŸ“ˆ åˆ†æç»“æœ</h2>
            <div id="statsGrid" class="stats-grid"></div>
            <div id="topResults"></div>
            <div id="detailResults"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let purchaseData = [];
        let activityLeadData = [];
        let companies = [];
        let activities = [];
        let products = [];

        // ç›‘å¬æ–‡ä»¶é€‰æ‹©
        document.getElementById('purchaseFile').addEventListener('change', (e) => {
            handleFileUpload(e.target.files[0], 'purchase');
        });

        document.getElementById('leadFile').addEventListener('change', (e) => {
            handleFileUpload(e.target.files[0], 'lead');
        });

        // å¤„ç†å•ä¸ªæ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(file, type) {
            if (!file) return;

            const reader = new FileReader();
            const infoDiv = type === 'purchase' ? 'purchaseInfo' : 'leadInfo';

            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    console.log(`è¯»å–${type}æ–‡ä»¶:`, file.name, 'æ•°æ®æ¡æ•°:', jsonData.length);
                    const fields = Object.keys(jsonData[0] || {});
                    console.log('å­—æ®µåˆ—è¡¨:', fields);
                    console.log('å­—æ®µJSON:', JSON.stringify(fields));
                    console.log('ç¬¬ä¸€è¡Œæ•°æ®:', jsonData[0]);
                    console.log('ç¬¬ä¸€è¡ŒJSON:', JSON.stringify(jsonData[0], null, 2));

                    if (type === 'purchase') {
                        purchaseData = jsonData;
                        document.getElementById(infoDiv).innerHTML = `âœ… å·²ä¸Šä¼ : ${file.name}<br>æ•°æ®æ¡æ•°: ${jsonData.length}`;
                    } else {
                        activityLeadData = jsonData;
                        document.getElementById(infoDiv).innerHTML = `âœ… å·²ä¸Šä¼ : ${file.name}<br>æ•°æ®æ¡æ•°: ${jsonData.length}`;
                    }

                    document.getElementById(infoDiv).classList.add('show');

                    // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¼€å§‹åˆ†æ
                    checkAnalyzeReady();

                } catch (error) {
                    console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', error);
                    document.getElementById(infoDiv).innerHTML = `âŒ è¯»å–å¤±è´¥: ${error.message}`;
                    document.getElementById(infoDiv).style.background = '#ffebee';
                    document.getElementById(infoDiv).style.color = '#c62828';
                    document.getElementById(infoDiv).classList.add('show');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¼€å§‹åˆ†æ
        function checkAnalyzeReady() {
            const btn = document.getElementById('analyzeBtn');
            if (purchaseData.length > 0 || activityLeadData.length > 0) {
                btn.disabled = false;
            }
        }

        // å¼€å§‹åˆ†æ
        document.getElementById('analyzeBtn').addEventListener('click', () => {
            console.log('å¼€å§‹åˆ†æ...');
            console.log('è´­ä¹°æ•°æ®:', purchaseData.length, 'æ¡');
            console.log('çº¿ç´¢æ•°æ®:', activityLeadData.length, 'æ¡');

            try {
                companies = analyzeCompanies();
                activities = analyzeActivities();
                products = analyzeProducts();

                console.log('åˆ†æå®Œæˆ');
                console.log('ä¼ä¸šæ•°:', companies.length);
                console.log('æ´»åŠ¨æ•°:', activities.length);
                console.log('äº§å“æ•°:', products.length);

                displayResults(companies, activities, products);

                document.getElementById('uploadStatus').innerHTML = '<div class="status success">âœ… åˆ†æå®Œæˆï¼è¯·æŸ¥çœ‹ä¸‹æ–¹ç»“æœ</div>';
                document.getElementById('qaSection').classList.add('show');
                document.getElementById('analysisSection').classList.add('show');
                document.getElementById('qaSection').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                document.getElementById('uploadStatus').innerHTML = `<div class="status error">âŒ åˆ†æå¤±è´¥: ${error.message}</div>`;
            }
        });

        // åˆ†æä¼ä¸šæ•°æ®
        function analyzeCompanies() {
            console.log('å¼€å§‹åˆ†æä¼ä¸šï¼Œè´­ä¹°æ•°æ®æ¡æ•°:', purchaseData.length);
            if (purchaseData.length > 0) {
                const fields = Object.keys(purchaseData[0]);
                console.log('==================');
                console.log('è´­ä¹°æ•°æ®å­—æ®µååˆ—è¡¨:');
                fields.forEach((f, i) => console.log(`  [${i}] "${f}" (é•¿åº¦:${f.length})`));
                console.log('==================');
                console.log('ç¬¬ä¸€æ¡æ•°æ®å†…å®¹:', purchaseData[0]);
            }
            
            const companyMap = new Map();
            let foundCount = 0;

            purchaseData.forEach((row, index) => {
                // è·å–æ‰€æœ‰å­—æ®µï¼Œæ‰¾åˆ°åŒ…å«"å…¬å¸"æˆ–"Company"çš„å­—æ®µ
                const allFields = Object.keys(row);
                let name = null;
                
                // å…ˆå°è¯•ç²¾ç¡®åŒ¹é…ï¼ˆæ³¨æ„ï¼šå®é™…æ•°æ®ä¸­æ˜¯"å…¬å¸å"è€Œä¸æ˜¯"å…¬å¸åç§°"ï¼‰
                name = row['å…¬å¸å'] || row['å…¬å¸åç§°'] || row['Company'] || row['å…¬å¸'] || 
                       row['ä¼ä¸šåç§°'] || row['å®¢æˆ·åç§°'] || row['company'] || 
                       row['å®¢æˆ·'] || row['ä¼ä¸š'];
                
                // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œæ¨¡ç³ŠåŒ¹é…åŒ…å«å…³é”®è¯çš„å­—æ®µ
                if (!name) {
                    for (let field of allFields) {
                        const fieldLower = field.toLowerCase().trim();
                        if (field.includes('å…¬å¸') || fieldLower === 'company') {
                            name = row[field];
                            if (index === 0) console.log(`ä½¿ç”¨æ¨¡ç³ŠåŒ¹é…å­—æ®µ: "${field}" = "${name}"`);
                            if (name) break;
                        }
                    }
                }
                
                if (!name) {
                    if (index < 3) {
                        console.log(`ç¬¬ ${index + 1} è¡Œæ²¡æœ‰å…¬å¸åç§°`);
                        console.log('  å¯ç”¨å­—æ®µ:', allFields);
                        console.log('  è¡Œæ•°æ®:', row);
                    }
                    return;
                }
                
                foundCount++;

                if (!companyMap.has(name)) {
                    companyMap.set(name, {
                        name: name,
                        totalAmount: 0,
                        newAmount: 0,
                        newCustomerAmount: 0,
                        activities: new Set(),
                        products: new Set(),
                        purchaseCount: 0
                    });
                }

                const company = companyMap.get(name);
                
                // æ‰©å±•é‡‘é¢å­—æ®µåŒ¹é…
                const amountFields = ['åˆåŒè®¢å•é‡‘é¢/ä¸‡å…ƒ', 'åˆåŒè®¢å•é‡‘é¢', 'è®¢å•é‡‘é¢', 'é‡‘é¢', 'amount', 'Amount'];
                const newAmountFields = ['æ–°è´­åˆåŒè®¢å•é‡‘é¢/ä¸‡å…ƒ', 'æ–°è´­åˆåŒè®¢å•é‡‘é¢', 'æ–°è´­é‡‘é¢', 'æ–°è´­è®¢å•é‡‘é¢'];
                const newCustomerFields = ['æ–°å®¢æˆ·åˆåŒè®¢å•é‡‘é¢/ä¸‡å…ƒ', 'æ–°å®¢æˆ·åˆåŒè®¢å•é‡‘é¢', 'æ–°å®¢æˆ·é‡‘é¢', 'æ–°å®¢æˆ·è®¢å•é‡‘é¢', 'æ–°å®¢æˆ·åˆåŒè®¢å•é‡‘é¢'];
                
                let totalAmount = 0;
                for (let field of amountFields) {
                    if (row[field] !== undefined && row[field] !== null && row[field] !== '') {
                        totalAmount = parseFloat(row[field]) || 0;
                        break;
                    }
                }
                
                let newAmount = 0;
                for (let field of newAmountFields) {
                    if (row[field] !== undefined) {
                        newAmount = parseFloat(row[field]) || 0;
                        break;
                    }
                }
                
                let newCustomerAmount = 0;
                for (let field of newCustomerFields) {
                    if (row[field] !== undefined) {
                        newCustomerAmount = parseFloat(row[field]) || 0;
                        break;
                    }
                }
                
                company.totalAmount += totalAmount;
                company.newAmount += newAmount;
                company.newCustomerAmount += newCustomerAmount;
                
                // æ´»åŠ¨å­—æ®µåŒ¹é…ï¼ˆæ”¯æŒ"æ´»åŠ¨å†…å®¹åç§°"ï¼‰
                const activity = row['æ´»åŠ¨å†…å®¹åç§°'] || row['æ´»åŠ¨åç§°'] || row['Activity'] || row['æ´»åŠ¨'] || row['activity'];
                // äº§å“å­—æ®µåŒ¹é…ï¼ˆæ³¨æ„ï¼šå®é™…æ•°æ®ä¸­æ˜¯"äº§å“å­ç±»"ï¼‰
                const product = row['äº§å“å­ç±»'] || row['äº§å“åç§°'] || row['Product'] || row['äº§å“'] || row['product'];
                
                if (activity) company.activities.add(activity);
                if (product) company.products.add(product);
                company.purchaseCount += 1;
            });

            const result = Array.from(companyMap.values()).map(c => ({
                ...c,
                activities: Array.from(c.activities).filter(a => a),
                products: Array.from(c.products).filter(p => p)
            }));
            
            console.log(`æ‰¾åˆ° ${foundCount} æ¡æœ‰æ•ˆå…¬å¸æ•°æ®ï¼Œåˆ†æå‡º ${result.length} ä¸ªå…¬å¸`);
            if (result.length > 0) console.log('ç¬¬ä¸€ä¸ªå…¬å¸:', result[0]);
            return result;
        }

        // åˆ†ææ´»åŠ¨æ•°æ®
        function analyzeActivities() {
            console.log('å¼€å§‹åˆ†ææ´»åŠ¨ï¼Œçº¿ç´¢æ•°æ®æ¡æ•°:', activityLeadData.length);
            if (activityLeadData.length > 0) {
                console.log('ç¬¬ä¸€æ¡çº¿ç´¢æ•°æ®å­—æ®µ:', Object.keys(activityLeadData[0]));
                console.log('ç¬¬ä¸€æ¡çº¿ç´¢æ•°æ®å†…å®¹:', activityLeadData[0]);
            }
            
            const activityMap = new Map();
            let foundCount = 0;

            activityLeadData.forEach((row, index) => {
                const name = row['æ´»åŠ¨å†…å®¹åç§°'] || row['æ´»åŠ¨å†…å®¹åç§°--åˆ†å±‚'] || row['æ´»åŠ¨åç§°'] || row['Activity'] || row['æ´»åŠ¨'] || row['activity'];
                if (!name) {
                    if (index < 5) console.log(`ç¬¬ ${index + 1} è¡Œçº¿ç´¢æ•°æ®æ²¡æœ‰æ´»åŠ¨åç§°ï¼Œå­—æ®µ:`, Object.keys(row));
                    return;
                }
                
                foundCount++;

                activityMap.set(name, {
                    name: name,
                    leads: parseInt(row['çº¿ç´¢æ•°'] || row['çº¿ç´¢æ•°é‡'] || row['leads'] || 0),
                    reachedCompanies: parseInt(row['è§¦è¾¾ä¼ä¸šæ•°'] || row['åˆåŒè®¢å•ä¼ä¸šæ•°'] || row['è§¦è¾¾å…¬å¸æ•°'] || row['reached'] || 0),
                    conversion: parseFloat(String(row['åˆåŒè®¢å•è½¬åŒ–ç‡'] || row['å•†æœºæˆ–è®¤è¯è½¬åŒ–ç‡'] || row['è½¬åŒ–ç‡'] || '0').replace('%', '')),
                    amount: parseFloat(row['åˆåŒè®¢å•é‡‘é¢/ä¸‡å…ƒ'] || row['åˆåŒè®¢å•é‡‘é¢'] || row['è®¢å•é‡‘é¢'] || row['é‡‘é¢'] || 0),
                    newConversion: parseFloat(String(row['æ–°è´­åˆåŒè®¢å•è½¬åŒ–ç‡'] || row['æ–°è´­è½¬åŒ–ç‡'] || '0').replace('%', '')),
                    newCustomerAmount: parseFloat(row['æ–°å®¢æˆ·åˆåŒè®¢å•é‡‘é¢/ä¸‡å…ƒ'] || row['æ–°å®¢æˆ·åˆåŒè®¢å•é‡‘é¢'] || row['æ–°å®¢æˆ·é‡‘é¢'] || 0)
                });
            });

            const result = Array.from(activityMap.values());
            console.log(`æ‰¾åˆ° ${foundCount} æ¡æœ‰æ•ˆæ´»åŠ¨æ•°æ®ï¼Œåˆ†æå‡º ${result.length} ä¸ªæ´»åŠ¨`);
            if (result.length > 0) console.log('ç¬¬ä¸€ä¸ªæ´»åŠ¨:', result[0]);
            return result;
        }

        // åˆ†æäº§å“æ•°æ®
        function analyzeProducts() {
            console.log('å¼€å§‹åˆ†æäº§å“ï¼Œè´­ä¹°æ•°æ®æ¡æ•°:', purchaseData.length);
            
            const productMap = new Map();
            let foundCount = 0;

            purchaseData.forEach((row, index) => {
                const name = row['äº§å“å­ç±»'] || row['äº§å“åç§°'] || row['Product'] || row['äº§å“'] || row['product'];
                if (!name) {
                    if (index < 5) console.log(`ç¬¬ ${index + 1} è¡Œæ²¡æœ‰äº§å“åç§°ï¼Œå­—æ®µ:`, Object.keys(row));
                    return;
                }
                
                foundCount++;

                if (!productMap.has(name)) {
                    productMap.set(name, {
                        name: name,
                        totalAmount: 0,
                        newAmount: 0,
                        purchaseCount: 0,
                        companies: new Set()
                    });
                }

                const product = productMap.get(name);
                
                // é‡‘é¢å­—æ®µåŒ¹é…
                const amountFields = ['åˆåŒè®¢å•é‡‘é¢/ä¸‡å…ƒ', 'åˆåŒè®¢å•é‡‘é¢', 'è®¢å•é‡‘é¢', 'é‡‘é¢'];
                const newAmountFields = ['æ–°è´­åˆåŒè®¢å•é‡‘é¢/ä¸‡å…ƒ', 'æ–°è´­é‡‘é¢'];
                
                let totalAmount = 0;
                for (let field of amountFields) {
                    if (row[field] !== undefined && row[field] !== null && row[field] !== '') {
                        totalAmount = parseFloat(row[field]) || 0;
                        break;
                    }
                }
                
                let newAmount = 0;
                for (let field of newAmountFields) {
                    if (row[field] !== undefined) {
                        newAmount = parseFloat(row[field]) || 0;
                        break;
                    }
                }
                
                product.totalAmount += totalAmount;
                product.newAmount += newAmount;
                product.purchaseCount += 1;
                
                const company = row['å…¬å¸å'] || row['å…¬å¸åç§°'] || row['Company'] || row['å…¬å¸'] || row['ä¼ä¸šåç§°'] || row['å®¢æˆ·åç§°'];
                if (company) product.companies.add(company);
            });

            const result = Array.from(productMap.values()).map(p => ({
                ...p,
                companyCount: p.companies.size,
                companies: Array.from(p.companies)
            }));
            
            console.log(`æ‰¾åˆ° ${foundCount} æ¡æœ‰æ•ˆäº§å“æ•°æ®ï¼Œåˆ†æå‡º ${result.length} ä¸ªäº§å“`);
            if (result.length > 0) console.log('ç¬¬ä¸€ä¸ªäº§å“:', result[0]);
            return result;
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(companies, activities, products) {
            console.log('å¼€å§‹æ˜¾ç¤ºç»“æœ');
            console.log('Companies:', companies);
            console.log('Activities:', activities);
            console.log('Products:', products);
            
            const totalRevenue = companies.reduce((sum, c) => sum + c.totalAmount, 0);
            const totalLeads = activities.reduce((sum, a) => sum + a.leads, 0);
            const avgConversion = activities.length > 0 ? activities.reduce((sum, a) => sum + a.conversion, 0) / activities.length : 0;
            const totalReached = activities.reduce((sum, a) => sum + a.reachedCompanies, 0);
            
            console.log('ç»Ÿè®¡æ•°æ®:', { totalRevenue, totalLeads, avgConversion, totalReached });

            // ç»Ÿè®¡å¡ç‰‡
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">æ€»é”€å”®é¢ï¼ˆä¸‡å…ƒï¼‰</div>
                    <div class="stat-value">${totalRevenue.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ€»çº¿ç´¢æ•°</div>
                    <div class="stat-value">${totalLeads.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">è§¦è¾¾ä¼ä¸šæ•°</div>
                    <div class="stat-value">${totalReached}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡è½¬åŒ–ç‡</div>
                    <div class="stat-value">${avgConversion.toFixed(2)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">è´­ä¹°ä¼ä¸šæ•°</div>
                    <div class="stat-value">${companies.length}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ´»åŠ¨æ•°é‡</div>
                    <div class="stat-value">${activities.length}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">äº§å“ç§ç±»</div>
                    <div class="stat-value">${products.length}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">çº¿ç´¢ä»·å€¼ï¼ˆä¸‡å…ƒï¼‰</div>
                    <div class="stat-value">${totalLeads > 0 ? (totalRevenue / totalLeads).toFixed(4) : '0'}</div>
                </div>
            `;

            // Topæ¦œå•
            const topCompany = [...companies].sort((a, b) => b.totalAmount - a.totalAmount)[0];
            const topActivity = [...activities].sort((a, b) => b.amount - a.amount)[0];
            const topProduct = [...products].sort((a, b) => b.totalAmount - a.totalAmount)[0];

            let topHTML = '';
            if (topCompany) {
                topHTML += `
                    <div class="result-card">
                        <div class="result-title">ğŸ† æœ€é«˜æ¶ˆè´¹ä¼ä¸š</div>
                        <div style="color: #666;">
                            <strong style="color: #333; font-size: 18px;">${topCompany.name}</strong><br>
                            æ€»æ¶ˆè´¹: ${topCompany.totalAmount.toFixed(2)} ä¸‡å…ƒ | 
                            æ–°è´­: ${topCompany.newAmount.toFixed(2)} ä¸‡å…ƒ | 
                            å‚ä¸æ´»åŠ¨: ${topCompany.activities.length} ä¸ª | 
                            è´­ä¹°äº§å“: ${topCompany.products.length} ç§
                        </div>
                    </div>
                `;
            }

            if (topActivity) {
                topHTML += `
                    <div class="result-card">
                        <div class="result-title">ğŸ¯ æœ€ä½³æ´»åŠ¨</div>
                        <div style="color: #666;">
                            <strong style="color: #333; font-size: 18px;">${topActivity.name}</strong><br>
                            é”€å”®é¢: ${topActivity.amount} ä¸‡å…ƒ | 
                            çº¿ç´¢æ•°: ${topActivity.leads} | 
                            è½¬åŒ–ç‡: ${topActivity.conversion}% | 
                            è§¦è¾¾: ${topActivity.reachedCompanies} å®¶ä¼ä¸š
                        </div>
                    </div>
                `;
            }

            if (topProduct) {
                topHTML += `
                    <div class="result-card">
                        <div class="result-title">ğŸ’ æœ€ç•…é”€äº§å“</div>
                        <div style="color: #666;">
                            <strong style="color: #333; font-size: 18px;">${topProduct.name}</strong><br>
                            é”€å”®é¢: ${topProduct.totalAmount.toFixed(2)} ä¸‡å…ƒ | 
                            è´­ä¹°æ¬¡æ•°: ${topProduct.purchaseCount} | 
                            è´­ä¹°ä¼ä¸š: ${topProduct.companyCount} å®¶
                        </div>
                    </div>
                `;
            }

            document.getElementById('topResults').innerHTML = topHTML;

            // è¯¦ç»†è¡¨æ ¼
            let tableHTML = '';

            if (companies.length > 0) {
                const sorted = [...companies].sort((a, b) => b.totalAmount - a.totalAmount);
                tableHTML += '<h3 style="margin: 30px 0 10px 0;">ğŸ“Š ä¼ä¸šè´­ä¹°æ’å</h3><table><thead><tr>';
                tableHTML += '<th>æ’å</th><th>ä¼ä¸šåç§°</th><th>æ€»æ¶ˆè´¹ï¼ˆä¸‡å…ƒï¼‰</th><th>æ–°è´­ï¼ˆä¸‡å…ƒï¼‰</th><th>å‚ä¸æ´»åŠ¨</th><th>è´­ä¹°äº§å“</th><th>è´­ä¹°æ¬¡æ•°</th></tr></thead><tbody>';
                
                sorted.slice(0, 20).forEach((c, i) => {
                    tableHTML += `<tr>
                        <td><strong>${i + 1}</strong></td>
                        <td><strong>${c.name}</strong></td>
                        <td>${c.totalAmount.toFixed(2)}</td>
                        <td>${c.newAmount.toFixed(2)}</td>
                        <td>${c.activities.length}</td>
                        <td>${c.products.length}</td>
                        <td>${c.purchaseCount}</td>
                    </tr>`;
                });
                tableHTML += '</tbody></table>';
            }

            if (activities.length > 0) {
                const sorted = [...activities].sort((a, b) => b.amount - a.amount);
                tableHTML += '<h3 style="margin: 30px 0 10px 0;">ğŸ¯ æ´»åŠ¨æ•ˆæœæ’å</h3><table><thead><tr>';
                tableHTML += '<th>æ´»åŠ¨åç§°</th><th>çº¿ç´¢æ•°</th><th>è§¦è¾¾ä¼ä¸š</th><th>è½¬åŒ–ç‡</th><th>é”€å”®é¢ï¼ˆä¸‡å…ƒï¼‰</th><th>æ–°è´­è½¬åŒ–ç‡</th></tr></thead><tbody>';
                
                sorted.forEach(a => {
                    tableHTML += `<tr>
                        <td><strong>${a.name}</strong></td>
                        <td>${a.leads}</td>
                        <td>${a.reachedCompanies}</td>
                        <td>${a.conversion}%</td>
                        <td>${a.amount}</td>
                        <td>${a.newConversion}%</td>
                    </tr>`;
                });
                tableHTML += '</tbody></table>';
            }

            if (products.length > 0) {
                const sorted = [...products].sort((a, b) => b.totalAmount - a.totalAmount);
                tableHTML += '<h3 style="margin: 30px 0 10px 0;">ğŸ’ äº§å“é”€å”®æ’å</h3><table><thead><tr>';
                tableHTML += '<th>æ’å</th><th>äº§å“åç§°</th><th>é”€å”®é¢ï¼ˆä¸‡å…ƒï¼‰</th><th>æ–°è´­ï¼ˆä¸‡å…ƒï¼‰</th><th>è´­ä¹°æ¬¡æ•°</th><th>è´­ä¹°ä¼ä¸š</th></tr></thead><tbody>';
                
                sorted.forEach((p, i) => {
                    tableHTML += `<tr>
                        <td><strong>${i + 1}</strong></td>
                        <td><strong>${p.name}</strong></td>
                        <td>${p.totalAmount.toFixed(2)}</td>
                        <td>${p.newAmount.toFixed(2)}</td>
                        <td>${p.purchaseCount}</td>
                        <td>${p.companyCount}</td>
                    </tr>`;
                });
                tableHTML += '</tbody></table>';
            }

            document.getElementById('detailResults').innerHTML = tableHTML;
        }

        // ==================== æ™ºèƒ½é—®ç­”åŠŸèƒ½ ====================
        
        // é—®ç­”æŒ‰é’®äº‹ä»¶
        document.getElementById('qaBtn').addEventListener('click', handleQuestion);
        document.getElementById('qaInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleQuestion();
        });

        // ç¤ºä¾‹é—®é¢˜ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.example-tag').forEach(tag => {
            tag.addEventListener('click', () => {
                const question = tag.getAttribute('data-q');
                document.getElementById('qaInput').value = question;
                handleQuestion();
            });
        });

        // å¤„ç†ç”¨æˆ·æé—®
        function handleQuestion() {
            const question = document.getElementById('qaInput').value.trim();
            const resultDiv = document.getElementById('qaResult');
            
            if (!question) {
                resultDiv.innerHTML = '<div class="qa-answer" style="color: #c62828;">è¯·è¾“å…¥æ‚¨çš„é—®é¢˜</div>';
                resultDiv.classList.add('show');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰åˆ†ææ•°æ®
            if (!companies || !activities || !products || companies.length === 0) {
                resultDiv.innerHTML = '<div class="qa-answer" style="color: #c62828;">è¯·å…ˆä¸Šä¼ æ•°æ®å¹¶ç‚¹å‡»"å¼€å§‹åˆ†æ"</div>';
                resultDiv.classList.add('show');
                return;
            }

            // åˆ†æé—®é¢˜å¹¶ç”Ÿæˆç­”æ¡ˆ
            const answer = analyzeQuestion(question);
            resultDiv.innerHTML = answer;
            resultDiv.classList.add('show');
            
            // æ»šåŠ¨åˆ°ç»“æœ
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // æ™ºèƒ½åˆ†æé—®é¢˜
        function analyzeQuestion(question) {
            const q = question.toLowerCase();
            
            console.log('æ”¶åˆ°é—®é¢˜:', question);
            console.log('å½“å‰æ•°æ®çŠ¶æ€:', {
                companies: companies.length,
                activities: activities.length,
                products: products.length
            });
            
            // ==================== æ–°å¢ï¼šå…³è”æŸ¥è¯¢åŠŸèƒ½ ====================
            
            // æ–°å¢æŸ¥è¯¢1: æŸä¸ªå…¬å¸è´­ä¹°äº†å“ªäº›äº§å“
            // å…³é”®ï¼šé—®é¢˜ä¸­åŒ…å«å…¬å¸å + (è´­ä¹°/ä¹°äº†) + äº§å“
            for (let company of companies) {
                if (q.includes(company.name.toLowerCase()) || question.includes(company.name)) {
                    if ((q.includes('è´­ä¹°') || q.includes('ä¹°äº†') || q.includes('ä¹°è¿‡')) && (q.includes('äº§å“') || q.includes('ä»€ä¹ˆ'))) {
                        console.log('åŒ¹é…åˆ°å…¬å¸äº§å“æŸ¥è¯¢:', company.name);
                        
                        // ä»è´­ä¹°æ•°æ®ä¸­è·å–è¯¥å…¬å¸çš„è¯¦ç»†è´­ä¹°è®°å½•
                        const companyPurchases = purchaseData
                            .filter(row => {
                                const companyName = row['å…¬å¸å'] || row['å…¬å¸åç§°'] || row['Company'] || row['å…¬å¸'] || row['ä¼ä¸šåç§°'] || row['å®¢æˆ·åç§°'];
                                return companyName === company.name;
                            })
                            .map(row => {
                                const product = row['äº§å“å­ç±»'] || row['äº§å“åç§°'] || row['Product'] || row['äº§å“'] || row['product'];
                                const activity = row['æ´»åŠ¨å†…å®¹åç§°'] || row['æ´»åŠ¨åç§°'] || row['Activity'] || row['æ´»åŠ¨'] || row['activity'];
                                const amount = parseFloat(row['åˆåŒè®¢å•é‡‘é¢/ä¸‡å…ƒ'] || row['åˆåŒè®¢å•é‡‘é¢'] || row['è®¢å•é‡‘é¢'] || row['é‡‘é¢'] || 0);
                                return { product, activity, amount };
                            })
                            .filter(item => item.product);
                        
                        // æŒ‰äº§å“åˆ†ç»„ç»Ÿè®¡
                        const productStats = {};
                        companyPurchases.forEach(p => {
                            if (!productStats[p.product]) {
                                productStats[p.product] = {
                                    name: p.product,
                                    totalAmount: 0,
                                    count: 0,
                                    activities: new Set()
                                };
                            }
                            productStats[p.product].totalAmount += p.amount;
                            productStats[p.product].count += 1;
                            productStats[p.product].activities.add(p.activity);
                        });
                        
                        const productList = Object.values(productStats).sort((a, b) => b.totalAmount - a.totalAmount);
                        
                        return `
                            <h3>ğŸ¢ ${company.name} è´­ä¹°çš„äº§å“</h3>
                            <div class="qa-answer">
                                <p><strong>${company.name}</strong> å…±è´­ä¹°äº† <strong>${productList.length}</strong> ç§äº§å“ï¼š</p>
                                <div class="qa-data">
                                    ğŸ“¦ <strong>äº§å“è´­ä¹°è¯¦æƒ…ï¼ˆæŒ‰é‡‘é¢æ’åºï¼‰ï¼š</strong><br>
                                    ${productList.map((p, i) => 
                                        `${i + 1}. <strong>${p.name}</strong><br>
                                        ã€€ã€€â€¢ è´­ä¹°é‡‘é¢ï¼š${p.totalAmount.toFixed(2)} ä¸‡å…ƒ<br>
                                        ã€€ã€€â€¢ è´­ä¹°æ¬¡æ•°ï¼š${p.count} æ¬¡<br>
                                        ã€€ã€€â€¢ æ¶‰åŠæ´»åŠ¨ï¼š${Array.from(p.activities).join('ã€')}`
                                    ).join('<br><br>')}<br><br>
                                    ğŸ“Š <strong>${company.name} æ€»ä½“æ•°æ®ï¼š</strong><br>
                                    â€¢ æ€»æ¶ˆè´¹é‡‘é¢ï¼š${company.totalAmount.toFixed(2)} ä¸‡å…ƒ<br>
                                    â€¢ å‚ä¸æ´»åŠ¨æ•°ï¼š${company.activities.length} ä¸ª<br>
                                    â€¢ è´­ä¹°äº§å“ç§ç±»ï¼š${productList.length} ç§
                                </div>
                            </div>
                        `;
                    }
                }
            }
            
            // æ–°å¢æŸ¥è¯¢2: æŸä¸ªäº§å“è¢«å“ªäº›å…¬å¸è´­ä¹°
            // å…³é”®ï¼šé—®é¢˜ä¸­åŒ…å«äº§å“å + (è¢«/å“ªäº›) + (å…¬å¸/è´­ä¹°)
            for (let product of products) {
                if (q.includes(product.name.toLowerCase()) || question.includes(product.name)) {
                    if ((q.includes('è¢«') || q.includes('å“ªäº›')) && (q.includes('å…¬å¸') || q.includes('ä¼ä¸š') || q.includes('è´­ä¹°'))) {
                        console.log('åŒ¹é…åˆ°äº§å“å…¬å¸æŸ¥è¯¢:', product.name);
                        
                        // ä»è´­ä¹°æ•°æ®ä¸­è·å–è´­ä¹°è¯¥äº§å“çš„è¯¦ç»†ä¿¡æ¯
                        const productPurchases = purchaseData
                            .filter(row => {
                                const prodName = row['äº§å“å­ç±»'] || row['äº§å“åç§°'] || row['Product'] || row['äº§å“'] || row['product'];
                                return prodName === product.name;
                            })
                            .map(row => {
                                const companyName = row['å…¬å¸å'] || row['å…¬å¸åç§°'] || row['Company'] || row['å…¬å¸'] || row['ä¼ä¸šåç§°'] || row['å®¢æˆ·åç§°'];
                                const activity = row['æ´»åŠ¨å†…å®¹åç§°'] || row['æ´»åŠ¨åç§°'] || row['Activity'] || row['æ´»åŠ¨'] || row['activity'];
                                const amount = parseFloat(row['åˆåŒè®¢å•é‡‘é¢/ä¸‡å…ƒ'] || row['åˆåŒè®¢å•é‡‘é¢'] || row['è®¢å•é‡‘é¢'] || row['é‡‘é¢'] || 0);
                                return { companyName, activity, amount };
                            })
                            .filter(item => item.companyName);
                        
                        // æŒ‰å…¬å¸åˆ†ç»„ç»Ÿè®¡
                        const companyStats = {};
                        productPurchases.forEach(p => {
                            if (!companyStats[p.companyName]) {
                                companyStats[p.companyName] = {
                                    name: p.companyName,
                                    totalAmount: 0,
                                    count: 0,
                                    activities: new Set()
                                };
                            }
                            companyStats[p.companyName].totalAmount += p.amount;
                            companyStats[p.companyName].count += 1;
                            companyStats[p.companyName].activities.add(p.activity);
                        });
                        
                        const companyList = Object.values(companyStats).sort((a, b) => b.totalAmount - a.totalAmount);
                        
                        return `
                            <h3>ğŸ’ è´­ä¹° ${product.name} çš„å…¬å¸</h3>
                            <div class="qa-answer">
                                <p>å…±æœ‰ <strong>${companyList.length}</strong> å®¶å…¬å¸è´­ä¹°äº† <strong>${product.name}</strong>ï¼š</p>
                                <div class="qa-data">
                                    ğŸ¢ <strong>è´­ä¹°å…¬å¸è¯¦æƒ…ï¼ˆæŒ‰é‡‘é¢æ’åºï¼‰ï¼š</strong><br>
                                    ${companyList.map((c, i) => 
                                        `${i + 1}. <strong>${c.name}</strong><br>
                                        ã€€ã€€â€¢ è´­ä¹°é‡‘é¢ï¼š${c.totalAmount.toFixed(2)} ä¸‡å…ƒ<br>
                                        ã€€ã€€â€¢ è´­ä¹°æ¬¡æ•°ï¼š${c.count} æ¬¡<br>
                                        ã€€ã€€â€¢ æ¶‰åŠæ´»åŠ¨ï¼š${Array.from(c.activities).join('ã€')}`
                                    ).join('<br><br>')}<br><br>
                                    ğŸ“Š <strong>${product.name} æ€»ä½“æ•°æ®ï¼š</strong><br>
                                    â€¢ æ€»é”€å”®é¢ï¼š${product.totalAmount.toFixed(2)} ä¸‡å…ƒ<br>
                                    â€¢ æ€»è´­ä¹°æ¬¡æ•°ï¼š${product.purchaseCount} æ¬¡<br>
                                    â€¢ è´­ä¹°ä¼ä¸šæ•°ï¼š${companyList.length} å®¶
                                </div>
                            </div>
                        `;
                    }
                }
            }
            
            // æ–°å¢æŸ¥è¯¢3: æŸä¸ªæ´»åŠ¨ä¸­å“ªäº›å…¬å¸äº§ç”Ÿäº†è´­ä¹°
            // å…³é”®ï¼šé—®é¢˜ä¸­åŒ…å«æ´»åŠ¨å + (å“ªäº›å…¬å¸/æœ‰å“ªäº›) + (è´­ä¹°/ä¹°äº†)
            for (let activity of activities) {
                if (q.includes(activity.name.toLowerCase()) || question.includes(activity.name)) {
                    if ((q.includes('å“ªäº›å…¬å¸') || q.includes('å“ªäº›ä¼ä¸š') || q.includes('æœ‰å“ªäº›')) && (q.includes('è´­ä¹°') || q.includes('ä¹°äº†'))) {
                        console.log('åŒ¹é…åˆ°æ´»åŠ¨è´­ä¹°å…¬å¸æŸ¥è¯¢:', activity.name);
                        
                        // ä»è´­ä¹°æ•°æ®ä¸­æ‰¾å‡ºè¯¥æ´»åŠ¨ä¸­è´­ä¹°çš„å…¬å¸
                        const activityPurchases = purchaseData
                            .filter(row => {
                                const actName = row['æ´»åŠ¨å†…å®¹åç§°'] || row['æ´»åŠ¨åç§°'] || row['Activity'] || row['æ´»åŠ¨'] || row['activity'];
                                return actName === activity.name;
                            })
                            .map(row => {
                                const companyName = row['å…¬å¸å'] || row['å…¬å¸åç§°'] || row['Company'] || row['å…¬å¸'] || row['ä¼ä¸šåç§°'] || row['å®¢æˆ·åç§°'];
                                const product = row['äº§å“å­ç±»'] || row['äº§å“åç§°'] || row['Product'] || row['äº§å“'] || row['product'];
                                const amount = parseFloat(row['åˆåŒè®¢å•é‡‘é¢/ä¸‡å…ƒ'] || row['åˆåŒè®¢å•é‡‘é¢'] || row['è®¢å•é‡‘é¢'] || row['é‡‘é¢'] || 0);
                                return { companyName, product, amount };
                            })
                            .filter(item => item.companyName);
                        
                        // æŒ‰å…¬å¸åˆ†ç»„
                        const companyStats = {};
                        activityPurchases.forEach(p => {
                            if (!companyStats[p.companyName]) {
                                companyStats[p.companyName] = {
                                    name: p.companyName,
                                    totalAmount: 0,
                                    products: []
                                };
                            }
                            companyStats[p.companyName].totalAmount += p.amount;
                            companyStats[p.companyName].products.push({ name: p.product, amount: p.amount });
                        });
                        
                        const companyList = Object.values(companyStats).sort((a, b) => b.totalAmount - a.totalAmount);
                        
                        return `
                            <h3>ğŸ¯ ${activity.name} çš„è´­ä¹°å…¬å¸</h3>
                            <div class="qa-answer">
                                <p><strong>${activity.name}</strong> ä¸­æœ‰ <strong>${companyList.length}</strong> å®¶å…¬å¸äº§ç”Ÿäº†è´­ä¹°ï¼š</p>
                                <div class="qa-data">
                                    ğŸ¢ <strong>è´­ä¹°å…¬å¸è¯¦æƒ…ï¼ˆæŒ‰é‡‘é¢æ’åºï¼‰ï¼š</strong><br>
                                    ${companyList.map((c, i) => 
                                        `${i + 1}. <strong>${c.name}</strong> - ${c.totalAmount.toFixed(2)} ä¸‡å…ƒ<br>
                                        ã€€ã€€è´­ä¹°äº§å“ï¼š${c.products.map(p => `${p.name}(${p.amount}ä¸‡)`).join('ã€')}`
                                    ).join('<br><br>')}<br><br>
                                    ğŸ“Š <strong>${activity.name} æ•´ä½“æ•°æ®ï¼š</strong><br>
                                    â€¢ è´­ä¹°ä¼ä¸šæ•°ï¼š${companyList.length} å®¶<br>
                                    â€¢ æ€»é”€å”®é¢ï¼š${companyList.reduce((sum, c) => sum + c.totalAmount, 0).toFixed(2)} ä¸‡å…ƒ<br>
                                    â€¢ è§¦è¾¾ä¼ä¸šæ•°ï¼š${activity.reachedCompanies} å®¶<br>
                                    â€¢ è½¬åŒ–ç‡ï¼š${activity.conversion.toFixed(2)}%<br>
                                    â€¢ çº¿ç´¢æ•°ï¼š${activity.leads}
                                </div>
                            </div>
                        `;
                    }
                }
            }
            
            // æ–°å¢æŸ¥è¯¢4: æŸä¸ªæ´»åŠ¨ä¸­å“ªäº›äº§å“è¢«è´­ä¹°
            // å…³é”®ï¼šé—®é¢˜ä¸­åŒ…å«æ´»åŠ¨å + (å“ªäº›äº§å“/ä»€ä¹ˆäº§å“) + (è¢«è´­ä¹°/ä¹°äº†)
            for (let activity of activities) {
                if (q.includes(activity.name.toLowerCase()) || question.includes(activity.name)) {
                    if ((q.includes('å“ªäº›äº§å“') || q.includes('ä»€ä¹ˆäº§å“') || q.includes('äº§å“')) && (q.includes('è¢«è´­ä¹°') || q.includes('è´­ä¹°') || q.includes('ä¹°äº†'))) {
                        console.log('åŒ¹é…åˆ°æ´»åŠ¨äº§å“æŸ¥è¯¢:', activity.name);
                        
                        // ä»è´­ä¹°æ•°æ®ä¸­æ‰¾å‡ºè¯¥æ´»åŠ¨ä¸­è¢«è´­ä¹°çš„äº§å“
                        const activityProducts = purchaseData
                            .filter(row => {
                                const actName = row['æ´»åŠ¨å†…å®¹åç§°'] || row['æ´»åŠ¨åç§°'] || row['Activity'] || row['æ´»åŠ¨'] || row['activity'];
                                return actName === activity.name;
                            })
                            .map(row => {
                                const product = row['äº§å“å­ç±»'] || row['äº§å“åç§°'] || row['Product'] || row['äº§å“'] || row['product'];
                                const companyName = row['å…¬å¸å'] || row['å…¬å¸åç§°'] || row['Company'] || row['å…¬å¸'] || row['ä¼ä¸šåç§°'] || row['å®¢æˆ·åç§°'];
                                const amount = parseFloat(row['åˆåŒè®¢å•é‡‘é¢/ä¸‡å…ƒ'] || row['åˆåŒè®¢å•é‡‘é¢'] || row['è®¢å•é‡‘é¢'] || row['é‡‘é¢'] || 0);
                                return { product, companyName, amount };
                            })
                            .filter(item => item.product);
                        
                        // æŒ‰äº§å“åˆ†ç»„
                        const productStats = {};
                        activityProducts.forEach(p => {
                            if (!productStats[p.product]) {
                                productStats[p.product] = {
                                    name: p.product,
                                    totalAmount: 0,
                                    count: 0,
                                    companies: []
                                };
                            }
                            productStats[p.product].totalAmount += p.amount;
                            productStats[p.product].count += 1;
                            productStats[p.product].companies.push({ name: p.companyName, amount: p.amount });
                        });
                        
                        const productList = Object.values(productStats).sort((a, b) => b.totalAmount - a.totalAmount);
                        
                        return `
                            <h3>ğŸ¯ ${activity.name} çš„äº§å“é”€å”®</h3>
                            <div class="qa-answer">
                                <p><strong>${activity.name}</strong> ä¸­æœ‰ <strong>${productList.length}</strong> ç§äº§å“è¢«è´­ä¹°ï¼š</p>
                                <div class="qa-data">
                                    ğŸ’ <strong>äº§å“é”€å”®è¯¦æƒ…ï¼ˆæŒ‰é‡‘é¢æ’åºï¼‰ï¼š</strong><br>
                                    ${productList.map((p, i) => 
                                        `${i + 1}. <strong>${p.name}</strong> - ${p.totalAmount.toFixed(2)} ä¸‡å…ƒ<br>
                                        ã€€ã€€â€¢ è´­ä¹°æ¬¡æ•°ï¼š${p.count} æ¬¡<br>
                                        ã€€ã€€â€¢ è´­ä¹°å…¬å¸ï¼š${p.companies.map(c => `${c.name}(${c.amount}ä¸‡)`).join('ã€')}`
                                    ).join('<br><br>')}<br><br>
                                    ğŸ“Š <strong>${activity.name} æ•´ä½“æ•°æ®ï¼š</strong><br>
                                    â€¢ äº§å“ç§ç±»ï¼š${productList.length} ç§<br>
                                    â€¢ æ€»é”€å”®é¢ï¼š${productList.reduce((sum, p) => sum + p.totalAmount, 0).toFixed(2)} ä¸‡å…ƒ<br>
                                    â€¢ è§¦è¾¾ä¼ä¸šæ•°ï¼š${activity.reachedCompanies} å®¶<br>
                                    â€¢ è½¬åŒ–ç‡ï¼š${activity.conversion.toFixed(2)}%
                                </div>
                            </div>
                        `;
                    }
                }
            }
            
            // 1. æŸ¥è¯¢æŸä¸ªå…¬å¸å‚åŠ äº†å“ªäº›æ´»åŠ¨ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼Œå…ˆåŒ¹é…ï¼‰
            // å…³é”®ï¼šé—®é¢˜ä¸­åŒ…å«å…¬å¸å + (å‚åŠ /å‚ä¸) + æ´»åŠ¨
            for (let company of companies) {
                if (q.includes(company.name.toLowerCase()) || question.includes(company.name)) {
                    if ((q.includes('å‚åŠ ') || q.includes('å‚ä¸')) && q.includes('æ´»åŠ¨')) {
                        console.log('åŒ¹é…åˆ°å…¬å¸æ´»åŠ¨æŸ¥è¯¢:', company.name);
                        return `
                            <h3>ğŸ¢ ${company.name} å‚åŠ çš„æ´»åŠ¨</h3>
                            <div class="qa-answer">
                                <p><strong>${company.name}</strong> å‚åŠ äº† <strong>${company.activities.length}</strong> ä¸ªæ´»åŠ¨ï¼š</p>
                                <div class="qa-data">
                                    ğŸ“‹ <strong>æ´»åŠ¨åˆ—è¡¨ï¼š</strong><br>
                                    ${company.activities.map((act, i) => `${i + 1}. ${act}`).join('<br>')}<br><br>
                                    ğŸ“Š <strong>è¯¥å…¬å¸æ€»ä½“æ•°æ®ï¼š</strong><br>
                                    â€¢ æ€»æ¶ˆè´¹é‡‘é¢ï¼š${company.totalAmount.toFixed(2)} ä¸‡å…ƒ<br>
                                    â€¢ æ–°è´­é‡‘é¢ï¼š${company.newAmount.toFixed(2)} ä¸‡å…ƒ<br>
                                    â€¢ è´­ä¹°äº§å“ï¼š${company.products.join('ã€')}<br>
                                    â€¢ è´­ä¹°æ¬¡æ•°ï¼š${company.purchaseCount} æ¬¡
                                </div>
                            </div>
                        `;
                    }
                }
            }
            
            // 2. æŸ¥è¯¢æŸä¸ªæ´»åŠ¨è§¦è¾¾äº†å“ªäº›å…¬å¸
            // å…³é”®ï¼šé—®é¢˜ä¸­åŒ…å«æ´»åŠ¨å + (è§¦è¾¾/æœ‰å“ªäº›/å‚åŠ ) + (å…¬å¸/ä¼ä¸š)
            for (let activity of activities) {
                if (q.includes(activity.name.toLowerCase()) || question.includes(activity.name)) {
                    if ((q.includes('è§¦è¾¾') || q.includes('æœ‰å“ªäº›') || q.includes('å“ªäº›å…¬å¸') || q.includes('å“ªäº›ä¼ä¸š')) && (q.includes('å…¬å¸') || q.includes('ä¼ä¸š'))) {
                        console.log('åŒ¹é…åˆ°æ´»åŠ¨å…¬å¸æŸ¥è¯¢:', activity.name);
                        // ä»è´­ä¹°æ•°æ®ä¸­æ‰¾å‡ºå‚åŠ è¯¥æ´»åŠ¨çš„å…¬å¸
                        const participatingCompanies = purchaseData
                            .filter(row => {
                                const actName = row['æ´»åŠ¨å†…å®¹åç§°'] || row['æ´»åŠ¨åç§°'] || row['Activity'] || row['æ´»åŠ¨'] || row['activity'];
                                return actName === activity.name;
                            })
                            .map(row => {
                                const companyName = row['å…¬å¸å'] || row['å…¬å¸åç§°'] || row['Company'] || row['å…¬å¸'] || row['ä¼ä¸šåç§°'] || row['å®¢æˆ·åç§°'];
                                const product = row['äº§å“å­ç±»'] || row['äº§å“åç§°'] || row['Product'] || row['äº§å“'] || row['product'];
                                const amount = parseFloat(row['åˆåŒè®¢å•é‡‘é¢/ä¸‡å…ƒ'] || row['åˆåŒè®¢å•é‡‘é¢'] || row['è®¢å•é‡‘é¢'] || row['é‡‘é¢'] || 0);
                                return { companyName, product, amount };
                            })
                            .filter(item => item.companyName);
                        
                        const uniqueCompanies = [...new Set(participatingCompanies.map(c => c.companyName))];
                        const totalActivityAmount = participatingCompanies.reduce((sum, c) => sum + c.amount, 0);
                        
                        return `
                            <h3>ğŸ¯ ${activity.name} è§¦è¾¾çš„å…¬å¸</h3>
                            <div class="qa-answer">
                                <p><strong>${activity.name}</strong> è§¦è¾¾äº† <strong>${uniqueCompanies.length}</strong> å®¶è´­ä¹°ä¼ä¸šï¼š</p>
                                <div class="qa-data">
                                    ğŸ“‹ <strong>è´­ä¹°ä¼ä¸šåˆ—è¡¨ï¼ˆæŒ‰é‡‘é¢æ’åºï¼‰ï¼š</strong><br>
                                    ${participatingCompanies
                                        .sort((a, b) => b.amount - a.amount)
                                        .map((item, i) => `${i + 1}. ${item.companyName} - ${item.product} (${item.amount.toFixed(2)}ä¸‡å…ƒ)`)
                                        .join('<br>')}<br><br>
                                    ğŸ“Š <strong>æ´»åŠ¨æ•´ä½“æ•°æ®ï¼š</strong><br>
                                    â€¢ è¯¥æ´»åŠ¨äº§ç”Ÿé”€å”®é¢ï¼š${totalActivityAmount.toFixed(2)} ä¸‡å…ƒ<br>
                                    â€¢ çº¿ç´¢æ•°ï¼š${activity.leads}<br>
                                    â€¢ è§¦è¾¾ä¼ä¸šæ•°ï¼ˆå«æœªè´­ä¹°ï¼‰ï¼š${activity.reachedCompanies} å®¶<br>
                                    â€¢ è½¬åŒ–ç‡ï¼š${activity.conversion.toFixed(2)}%<br>
                                    â€¢ å¹³å‡å®¢å•ä»·ï¼š${uniqueCompanies.length > 0 ? (totalActivityAmount / uniqueCompanies.length).toFixed(2) : '0'} ä¸‡å…ƒ
                                </div>
                            </div>
                        `;
                    }
                }
            }
            
            // 3. æŸ¥è¯¢å“ªäº›å…¬å¸è´­ä¹°äº†æŸä¸ªäº§å“
            if ((q.includes('è´­ä¹°') || q.includes('ä¹°äº†')) && (q.includes('å“ªäº›') || q.includes('å“ªä¸ª'))) {
                // å°è¯•æ‰¾åˆ°äº§å“åç§°
                for (let product of products) {
                    if (q.includes(product.name.toLowerCase()) || question.includes(product.name)) {
                        // ä»è´­ä¹°æ•°æ®ä¸­æ‰¾å‡ºè´­ä¹°è¯¥äº§å“çš„è¯¦ç»†ä¿¡æ¯
                        const productPurchases = purchaseData
                            .filter(row => {
                                const prodName = row['äº§å“å­ç±»'] || row['äº§å“åç§°'] || row['Product'] || row['äº§å“'] || row['product'];
                                return prodName === product.name;
                            })
                            .map(row => {
                                const companyName = row['å…¬å¸å'] || row['å…¬å¸åç§°'] || row['Company'] || row['å…¬å¸'] || row['ä¼ä¸šåç§°'] || row['å®¢æˆ·åç§°'];
                                const activity = row['æ´»åŠ¨å†…å®¹åç§°'] || row['æ´»åŠ¨åç§°'] || row['Activity'] || row['æ´»åŠ¨'] || row['activity'];
                                const amount = parseFloat(row['åˆåŒè®¢å•é‡‘é¢/ä¸‡å…ƒ'] || row['åˆåŒè®¢å•é‡‘é¢'] || row['è®¢å•é‡‘é¢'] || row['é‡‘é¢'] || 0);
                                return { companyName, activity, amount };
                            })
                            .filter(item => item.companyName);
                        
                        return `
                            <h3>ğŸ’ è´­ä¹°äº† ${product.name} çš„å…¬å¸</h3>
                            <div class="qa-answer">
                                <p>å…±æœ‰ <strong>${product.companyCount}</strong> å®¶å…¬å¸è´­ä¹°äº† <strong>${product.name}</strong>ï¼š</p>
                                <div class="qa-data">
                                    ğŸ“‹ <strong>è´­ä¹°è¯¦æƒ…ï¼ˆæŒ‰é‡‘é¢æ’åºï¼‰ï¼š</strong><br>
                                    ${productPurchases
                                        .sort((a, b) => b.amount - a.amount)
                                        .map((item, i) => `${i + 1}. ${item.companyName} - ${item.activity} (${item.amount.toFixed(2)}ä¸‡å…ƒ)`)
                                        .join('<br>')}<br><br>
                                    ğŸ“Š <strong>äº§å“æ•´ä½“æ•°æ®ï¼š</strong><br>
                                    â€¢ æ€»é”€å”®é¢ï¼š${product.totalAmount.toFixed(2)} ä¸‡å…ƒ<br>
                                    â€¢ è´­ä¹°æ¬¡æ•°ï¼š${product.purchaseCount} æ¬¡<br>
                                    â€¢ è´­ä¹°ä¼ä¸šï¼š${product.companyCount} å®¶<br>
                                    â€¢ å¹³å‡å•ä»·ï¼š${(product.totalAmount / product.purchaseCount).toFixed(2)} ä¸‡å…ƒ
                                </div>
                            </div>
                        `;
                    }
                }
            }
            
            // 4. æŸ¥è¯¢æŸä¸ªå…¬å¸åœ¨æŸä¸ªæ´»åŠ¨ä¸­çš„è¡¨ç°
            if (q.includes('åœ¨') && (q.includes('æ´»åŠ¨') || q.includes('å³°ä¼š') || q.includes('è®ºå›'))) {
                for (let company of companies) {
                    if (q.includes(company.name.toLowerCase()) || question.includes(company.name)) {
                        for (let activity of activities) {
                            if (q.includes(activity.name.toLowerCase()) || question.includes(activity.name)) {
                                // æŸ¥æ‰¾è¯¥å…¬å¸åœ¨è¯¥æ´»åŠ¨ä¸­çš„è´­ä¹°è®°å½•
                                const purchases = purchaseData
                                    .filter(row => {
                                        const companyName = row['å…¬å¸å'] || row['å…¬å¸åç§°'] || row['Company'] || row['å…¬å¸'] || row['ä¼ä¸šåç§°'] || row['å®¢æˆ·åç§°'];
                                        const actName = row['æ´»åŠ¨å†…å®¹åç§°'] || row['æ´»åŠ¨åç§°'] || row['Activity'] || row['æ´»åŠ¨'] || row['activity'];
                                        return companyName === company.name && actName === activity.name;
                                    })
                                    .map(row => {
                                        const product = row['äº§å“å­ç±»'] || row['äº§å“åç§°'] || row['Product'] || row['äº§å“'] || row['product'];
                                        const amount = parseFloat(row['åˆåŒè®¢å•é‡‘é¢/ä¸‡å…ƒ'] || row['åˆåŒè®¢å•é‡‘é¢'] || row['è®¢å•é‡‘é¢'] || row['é‡‘é¢'] || 0);
                                        return { product, amount };
                                    });
                                
                                if (purchases.length > 0) {
                                    const totalAmount = purchases.reduce((sum, p) => sum + p.amount, 0);
                                    return `
                                        <h3>ğŸ¯ ${company.name} åœ¨ ${activity.name}</h3>
                                        <div class="qa-answer">
                                            <p><strong>${company.name}</strong> åœ¨ <strong>${activity.name}</strong> ä¸­è´­ä¹°äº†ï¼š</p>
                                            <div class="qa-data">
                                                ğŸ“‹ <strong>è´­ä¹°è¯¦æƒ…ï¼š</strong><br>
                                                ${purchases.map((p, i) => `${i + 1}. ${p.product} - ${p.amount.toFixed(2)} ä¸‡å…ƒ`).join('<br>')}<br><br>
                                                ğŸ’° <strong>åœ¨è¯¥æ´»åŠ¨ä¸­çš„æ¶ˆè´¹ï¼š</strong>${totalAmount.toFixed(2)} ä¸‡å…ƒ<br><br>
                                                ğŸ“Š <strong>${company.name} æ€»ä½“æ•°æ®ï¼š</strong><br>
                                                â€¢ æ‰€æœ‰æ´»åŠ¨æ€»æ¶ˆè´¹ï¼š${company.totalAmount.toFixed(2)} ä¸‡å…ƒ<br>
                                                â€¢ å‚åŠ æ´»åŠ¨æ•°ï¼š${company.activities.length} ä¸ª<br><br>
                                                ğŸ¯ <strong>${activity.name} æ´»åŠ¨æ•´ä½“ï¼š</strong><br>
                                                â€¢ æ´»åŠ¨æ€»é”€å”®é¢ï¼š${activity.amount.toFixed(2)} ä¸‡å…ƒ<br>
                                                â€¢ è§¦è¾¾ä¼ä¸šæ•°ï¼š${activity.reachedCompanies} å®¶
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    return `
                                        <h3>ğŸ¯ ${company.name} ä¸ ${activity.name}</h3>
                                        <div class="qa-answer">
                                            <p>æ ¹æ®è´­ä¹°æ•°æ®ï¼Œ<strong>${company.name}</strong> åœ¨ <strong>${activity.name}</strong> ä¸­<strong>æ²¡æœ‰è´­ä¹°è®°å½•</strong>ã€‚</p>
                                            <div class="qa-data">
                                                ğŸ’¡ å¯èƒ½çš„æƒ…å†µï¼š<br>
                                                â€¢ è¯¥å…¬å¸å‚ä¸äº†æ´»åŠ¨ä½†æœªäº§ç”Ÿè´­ä¹°<br>
                                                â€¢ è¯¥å…¬å¸åœ¨å…¶ä»–æ´»åŠ¨ä¸­æœ‰è´­ä¹°ï¼š${company.activities.join('ã€')}<br><br>
                                                ğŸ“Š ${company.name} æ€»ä½“æ•°æ®ï¼š<br>
                                                â€¢ æ€»æ¶ˆè´¹é‡‘é¢ï¼š${company.totalAmount.toFixed(2)} ä¸‡å…ƒ<br>
                                                â€¢ å‚åŠ æ´»åŠ¨æ•°ï¼š${company.activities.length} ä¸ª
                                            </div>
                                        </div>
                                    `;
                                }
                            }
                        }
                    }
                }
            }
            
            // ==================== åŸæœ‰çš„åŸºç¡€æŸ¥è¯¢åŠŸèƒ½ ====================
            
            // 5. è¯¢é—®å…¬å¸ç›¸å…³é—®é¢˜
            if (q.includes('å…¬å¸') || q.includes('ä¼ä¸š') || q.includes('å®¢æˆ·')) {
                if (q.includes('æœ€é«˜') || q.includes('æœ€å¤š') || q.includes('ç¬¬ä¸€') || q.includes('top')) {
                    const topCompany = [...companies].sort((a, b) => b.totalAmount - a.totalAmount)[0];
                    return `
                        <h3>ğŸ’¼ ${question}</h3>
                        <div class="qa-answer">
                            <p><strong>ç­”æ¡ˆï¼š${topCompany.name}</strong></p>
                            <div class="qa-data">
                                ğŸ“Š <strong>è¯¦ç»†æ•°æ®ï¼š</strong><br>
                                â€¢ æ€»æ¶ˆè´¹é‡‘é¢ï¼š${topCompany.totalAmount.toFixed(2)} ä¸‡å…ƒ<br>
                                â€¢ æ–°è´­é‡‘é¢ï¼š${topCompany.newAmount.toFixed(2)} ä¸‡å…ƒ<br>
                                â€¢ æ–°å®¢æˆ·é‡‘é¢ï¼š${topCompany.newCustomerAmount.toFixed(2)} ä¸‡å…ƒ<br>
                                â€¢ å‚ä¸æ´»åŠ¨ï¼š${topCompany.activities.length} ä¸ª<br>
                                â€¢ è´­ä¹°äº§å“ï¼š${topCompany.products.length} ç§<br>
                                â€¢ è´­ä¹°æ¬¡æ•°ï¼š${topCompany.purchaseCount} æ¬¡
                            </div>
                        </div>
                    `;
                }
                if (q.includes('å¤šå°‘') || q.includes('æ•°é‡') || q.includes('æ€»å…±') || q.includes('æœ‰å‡ ')) {
                    return `
                        <h3>ğŸ’¼ ${question}</h3>
                        <div class="qa-answer">
                            <p><strong>ç­”æ¡ˆï¼š${companies.length} å®¶å…¬å¸</strong></p>
                            <div class="qa-data">
                                ğŸ“Š <strong>è¡¥å……ä¿¡æ¯ï¼š</strong><br>
                                â€¢ è´­ä¹°ä¼ä¸šæ€»æ•°ï¼š${companies.length} å®¶<br>
                                â€¢ æ€»æ¶ˆè´¹é‡‘é¢ï¼š${companies.reduce((s, c) => s + c.totalAmount, 0).toFixed(2)} ä¸‡å…ƒ<br>
                                â€¢ å¹³å‡å®¢å•ä»·ï¼š${(companies.reduce((s, c) => s + c.totalAmount, 0) / companies.length).toFixed(2)} ä¸‡å…ƒ
                            </div>
                        </div>
                    `;
                }
            }

            // 6. è¯¢é—®æ´»åŠ¨ç›¸å…³é—®é¢˜
            if (q.includes('æ´»åŠ¨')) {
                if (q.includes('æœ€å¥½') || q.includes('æœ€ä½³') || q.includes('æ•ˆæœ') || q.includes('æœ€é«˜')) {
                    const topActivity = [...activities].sort((a, b) => b.amount - a.amount)[0];
                    return `
                        <h3>ğŸ¯ ${question}</h3>
                        <div class="qa-answer">
                            <p><strong>ç­”æ¡ˆï¼š${topActivity.name}</strong></p>
                            <div class="qa-data">
                                ğŸ“Š <strong>è¯¦ç»†æ•°æ®ï¼š</strong><br>
                                â€¢ é”€å”®é¢ï¼š${topActivity.amount.toFixed(2)} ä¸‡å…ƒ<br>
                                â€¢ çº¿ç´¢æ•°ï¼š${topActivity.leads}<br>
                                â€¢ è§¦è¾¾ä¼ä¸šï¼š${topActivity.reachedCompanies} å®¶<br>
                                â€¢ è½¬åŒ–ç‡ï¼š${topActivity.conversion.toFixed(2)}%<br>
                                â€¢ æ–°è´­è½¬åŒ–ç‡ï¼š${topActivity.newConversion.toFixed(2)}%<br>
                                â€¢ å•ä¸ªçº¿ç´¢ä»·å€¼ï¼š${topActivity.leads > 0 ? (topActivity.amount / topActivity.leads).toFixed(4) : '0'} ä¸‡å…ƒ
                            </div>
                        </div>
                    `;
                }
                if (q.includes('å¤šå°‘') || q.includes('æ•°é‡') || q.includes('æ€»å…±') || q.includes('æœ‰å‡ ')) {
                    return `
                        <h3>ğŸ¯ ${question}</h3>
                        <div class="qa-answer">
                            <p><strong>ç­”æ¡ˆï¼š${activities.length} ä¸ªæ´»åŠ¨</strong></p>
                            <div class="qa-data">
                                ğŸ“Š <strong>è¡¥å……ä¿¡æ¯ï¼š</strong><br>
                                â€¢ æ´»åŠ¨æ€»æ•°ï¼š${activities.length} ä¸ª<br>
                                â€¢ æ€»çº¿ç´¢æ•°ï¼š${activities.reduce((s, a) => s + a.leads, 0)}<br>
                                â€¢ æ€»è§¦è¾¾ä¼ä¸šï¼š${activities.reduce((s, a) => s + a.reachedCompanies, 0)} å®¶<br>
                                â€¢ æ€»é”€å”®é¢ï¼š${activities.reduce((s, a) => s + a.amount, 0).toFixed(2)} ä¸‡å…ƒ
                            </div>
                        </div>
                    `;
                }
            }

            // 7. è¯¢é—®äº§å“ç›¸å…³é—®é¢˜
            if (q.includes('äº§å“')) {
                if (q.includes('æœ€ç•…é”€') || q.includes('æœ€å¥½') || q.includes('é”€é‡') || q.includes('æœ€é«˜')) {
                    const topProduct = [...products].sort((a, b) => b.totalAmount - a.totalAmount)[0];
                    return `
                        <h3>ğŸ’ ${question}</h3>
                        <div class="qa-answer">
                            <p><strong>ç­”æ¡ˆï¼š${topProduct.name}</strong></p>
                            <div class="qa-data">
                                ğŸ“Š <strong>è¯¦ç»†æ•°æ®ï¼š</strong><br>
                                â€¢ æ€»é”€å”®é¢ï¼š${topProduct.totalAmount.toFixed(2)} ä¸‡å…ƒ<br>
                                â€¢ æ–°è´­é‡‘é¢ï¼š${topProduct.newAmount.toFixed(2)} ä¸‡å…ƒ<br>
                                â€¢ è´­ä¹°æ¬¡æ•°ï¼š${topProduct.purchaseCount} æ¬¡<br>
                                â€¢ è´­ä¹°ä¼ä¸šï¼š${topProduct.companyCount} å®¶<br>
                                â€¢ å¹³å‡å•ä»·ï¼š${(topProduct.totalAmount / topProduct.purchaseCount).toFixed(2)} ä¸‡å…ƒ
                            </div>
                        </div>
                    `;
                }
                if (q.includes('å¤šå°‘') || q.includes('æ•°é‡') || q.includes('ç§ç±»') || q.includes('æœ‰å‡ ')) {
                    return `
                        <h3>ğŸ’ ${question}</h3>
                        <div class="qa-answer">
                            <p><strong>ç­”æ¡ˆï¼š${products.length} ç§äº§å“</strong></p>
                            <div class="qa-data">
                                ğŸ“Š <strong>è¡¥å……ä¿¡æ¯ï¼š</strong><br>
                                â€¢ äº§å“ç§ç±»ï¼š${products.length} ç§<br>
                                â€¢ æ€»é”€å”®é¢ï¼š${products.reduce((s, p) => s + p.totalAmount, 0).toFixed(2)} ä¸‡å…ƒ<br>
                                â€¢ æ€»è´­ä¹°æ¬¡æ•°ï¼š${products.reduce((s, p) => s + p.purchaseCount, 0)} æ¬¡
                            </div>
                        </div>
                    `;
                }
            }

            // 8. è¯¢é—®è½¬åŒ–ç‡
            if (q.includes('è½¬åŒ–ç‡')) {
                const avgConversion = activities.reduce((s, a) => s + a.conversion, 0) / activities.length;
                const topConversion = [...activities].sort((a, b) => b.conversion - a.conversion)[0];
                return `
                    <h3>ğŸ“ˆ ${question}</h3>
                    <div class="qa-answer">
                        <p><strong>å¹³å‡è½¬åŒ–ç‡ï¼š${avgConversion.toFixed(2)}%</strong></p>
                        <div class="qa-data">
                            ğŸ“Š <strong>è¯¦ç»†æ•°æ®ï¼š</strong><br>
                            â€¢ å¹³å‡åˆåŒè®¢å•è½¬åŒ–ç‡ï¼š${avgConversion.toFixed(2)}%<br>
                            â€¢ æœ€é«˜è½¬åŒ–ç‡æ´»åŠ¨ï¼š${topConversion.name}ï¼ˆ${topConversion.conversion.toFixed(2)}%ï¼‰<br>
                            â€¢ æ€»çº¿ç´¢æ•°ï¼š${activities.reduce((s, a) => s + a.leads, 0)}<br>
                            â€¢ æ€»é”€å”®é¢ï¼š${activities.reduce((s, a) => s + a.amount, 0).toFixed(2)} ä¸‡å…ƒ
                        </div>
                    </div>
                `;
            }

            // 9. è¯¢é—®é”€å”®é¢/é‡‘é¢
            if (q.includes('é”€å”®é¢') || q.includes('è¥æ”¶') || q.includes('é‡‘é¢') || q.includes('æ”¶å…¥')) {
                const totalRevenue = companies.reduce((s, c) => s + c.totalAmount, 0);
                const totalNew = companies.reduce((s, c) => s + c.newAmount, 0);
                const totalNewCustomer = companies.reduce((s, c) => s + c.newCustomerAmount, 0);
                return `
                    <h3>ğŸ’° ${question}</h3>
                    <div class="qa-answer">
                        <p><strong>æ€»é”€å”®é¢ï¼š${totalRevenue.toFixed(2)} ä¸‡å…ƒ</strong></p>
                        <div class="qa-data">
                            ğŸ“Š <strong>è¯¦ç»†æ•°æ®ï¼š</strong><br>
                            â€¢ åˆåŒè®¢å•æ€»é¢ï¼š${totalRevenue.toFixed(2)} ä¸‡å…ƒ<br>
                            â€¢ æ–°è´­é‡‘é¢ï¼š${totalNew.toFixed(2)} ä¸‡å…ƒï¼ˆå æ¯” ${(totalNew / totalRevenue * 100).toFixed(2)}%ï¼‰<br>
                            â€¢ æ–°å®¢æˆ·é‡‘é¢ï¼š${totalNewCustomer.toFixed(2)} ä¸‡å…ƒï¼ˆå æ¯” ${(totalNewCustomer / totalRevenue * 100).toFixed(2)}%ï¼‰<br>
                            â€¢ è´­ä¹°ä¼ä¸šæ•°ï¼š${companies.length} å®¶<br>
                            â€¢ å¹³å‡å®¢å•ä»·ï¼š${(totalRevenue / companies.length).toFixed(2)} ä¸‡å…ƒ
                        </div>
                    </div>
                `;
            }

            // 10. è¯¢é—®çº¿ç´¢
            if (q.includes('çº¿ç´¢')) {
                const totalLeads = activities.reduce((s, a) => s + a.leads, 0);
                const totalRevenue = companies.reduce((s, c) => s + c.totalAmount, 0);
                return `
                    <h3>ğŸ“Š ${question}</h3>
                    <div class="qa-answer">
                        <p><strong>æ€»çº¿ç´¢æ•°ï¼š${totalLeads}</strong></p>
                        <div class="qa-data">
                            ğŸ“Š <strong>è¯¦ç»†æ•°æ®ï¼š</strong><br>
                            â€¢ æ€»çº¿ç´¢æ•°ï¼š${totalLeads.toLocaleString()}<br>
                            â€¢ è§¦è¾¾ä¼ä¸šæ•°ï¼š${activities.reduce((s, a) => s + a.reachedCompanies, 0)} å®¶<br>
                            â€¢ å•ä¸ªçº¿ç´¢ä»·å€¼ï¼š${(totalRevenue / totalLeads).toFixed(4)} ä¸‡å…ƒ<br>
                            â€¢ æ€»é”€å”®é¢ï¼š${totalRevenue.toFixed(2)} ä¸‡å…ƒ
                        </div>
                    </div>
                `;
            }

            // 11. è¯¢é—®æ–°å®¢æˆ·
            if (q.includes('æ–°å®¢æˆ·') || q.includes('æ–°ç”¨æˆ·')) {
                const totalNewCustomer = companies.reduce((s, c) => s + c.newCustomerAmount, 0);
                const totalRevenue = companies.reduce((s, c) => s + c.totalAmount, 0);
                const newCustomerCompanies = companies.filter(c => c.newCustomerAmount > 0);
                return `
                    <h3>ğŸŒŸ ${question}</h3>
                    <div class="qa-answer">
                        <p><strong>æ–°å®¢æˆ·é‡‘é¢ï¼š${totalNewCustomer.toFixed(2)} ä¸‡å…ƒ</strong></p>
                        <div class="qa-data">
                            ğŸ“Š <strong>è¯¦ç»†æ•°æ®ï¼š</strong><br>
                            â€¢ æ–°å®¢æˆ·è®¢å•é‡‘é¢ï¼š${totalNewCustomer.toFixed(2)} ä¸‡å…ƒ<br>
                            â€¢ æ–°å®¢æˆ·å æ¯”ï¼š${(totalNewCustomer / totalRevenue * 100).toFixed(2)}%<br>
                            â€¢ æ–°å®¢æˆ·æ•°é‡ï¼š${newCustomerCompanies.length} å®¶<br>
                            â€¢ æ–°å®¢æˆ·å¹³å‡è®¢å•ï¼š${newCustomerCompanies.length > 0 ? (totalNewCustomer / newCustomerCompanies.length).toFixed(2) : '0'} ä¸‡å…ƒ
                        </div>
                    </div>
                `;
            }

            // 12. è¯¢é—®å…·ä½“å…¬å¸/æ´»åŠ¨/äº§å“
            // æŸ¥æ‰¾å…¬å¸
            const company = companies.find(c => q.includes(c.name.toLowerCase()));
            if (company) {
                return `
                    <h3>ğŸ¢ ${company.name}</h3>
                    <div class="qa-answer">
                        <div class="qa-data">
                            ğŸ“Š <strong>ä¼ä¸šè¯¦æƒ…ï¼š</strong><br>
                            â€¢ æ€»æ¶ˆè´¹é‡‘é¢ï¼š${company.totalAmount.toFixed(2)} ä¸‡å…ƒ<br>
                            â€¢ æ–°è´­é‡‘é¢ï¼š${company.newAmount.toFixed(2)} ä¸‡å…ƒ<br>
                            â€¢ æ–°å®¢æˆ·é‡‘é¢ï¼š${company.newCustomerAmount.toFixed(2)} ä¸‡å…ƒ<br>
                            â€¢ å‚ä¸æ´»åŠ¨ï¼š${company.activities.join('ã€')}<br>
                            â€¢ è´­ä¹°äº§å“ï¼š${company.products.join('ã€')}<br>
                            â€¢ è´­ä¹°æ¬¡æ•°ï¼š${company.purchaseCount} æ¬¡
                        </div>
                    </div>
                `;
            }

            // æŸ¥æ‰¾æ´»åŠ¨
            const activity = activities.find(a => q.includes(a.name.toLowerCase()));
            if (activity) {
                return `
                    <h3>ğŸ¯ ${activity.name}</h3>
                    <div class="qa-answer">
                        <div class="qa-data">
                            ğŸ“Š <strong>æ´»åŠ¨è¯¦æƒ…ï¼š</strong><br>
                            â€¢ é”€å”®é¢ï¼š${activity.amount.toFixed(2)} ä¸‡å…ƒ<br>
                            â€¢ çº¿ç´¢æ•°ï¼š${activity.leads}<br>
                            â€¢ è§¦è¾¾ä¼ä¸šï¼š${activity.reachedCompanies} å®¶<br>
                            â€¢ è½¬åŒ–ç‡ï¼š${activity.conversion.toFixed(2)}%<br>
                            â€¢ æ–°è´­è½¬åŒ–ç‡ï¼š${activity.newConversion.toFixed(2)}%<br>
                            â€¢ æ–°å®¢æˆ·é‡‘é¢ï¼š${activity.newCustomerAmount.toFixed(2)} ä¸‡å…ƒ<br>
                            â€¢ å•ä¸ªçº¿ç´¢ä»·å€¼ï¼š${activity.leads > 0 ? (activity.amount / activity.leads).toFixed(4) : '0'} ä¸‡å…ƒ
                        </div>
                    </div>
                `;
            }

            // æŸ¥æ‰¾äº§å“
            const product = products.find(p => q.includes(p.name.toLowerCase()));
            if (product) {
                return `
                    <h3>ğŸ’ ${product.name}</h3>
                    <div class="qa-answer">
                        <div class="qa-data">
                            ğŸ“Š <strong>äº§å“è¯¦æƒ…ï¼š</strong><br>
                            â€¢ æ€»é”€å”®é¢ï¼š${product.totalAmount.toFixed(2)} ä¸‡å…ƒ<br>
                            â€¢ æ–°è´­é‡‘é¢ï¼š${product.newAmount.toFixed(2)} ä¸‡å…ƒ<br>
                            â€¢ è´­ä¹°æ¬¡æ•°ï¼š${product.purchaseCount} æ¬¡<br>
                            â€¢ è´­ä¹°ä¼ä¸šï¼š${product.companyCount} å®¶<br>
                            â€¢ å¹³å‡å•ä»·ï¼š${(product.totalAmount / product.purchaseCount).toFixed(2)} ä¸‡å…ƒ<br>
                            â€¢ è´­ä¹°ä¼ä¸šåˆ—è¡¨ï¼š${product.companies.slice(0, 10).join('ã€')}${product.companies.length > 10 ? 'ç­‰' : ''}
                        </div>
                    </div>
                `;
            }

            // é»˜è®¤å›ç­”
            return `
                <h3>â“ ${question}</h3>
                <div class="qa-answer">
                    <p>æŠ±æ­‰ï¼Œæˆ‘è¿˜ä¸å¤ªç†è§£æ‚¨çš„é—®é¢˜ã€‚æ‚¨å¯ä»¥å°è¯•ä»¥ä¸‹æ–¹å¼æé—®ï¼š</p>
                    <div class="qa-data">
                        ğŸ’¡ <strong>åŸºç¡€ç»Ÿè®¡é—®é¢˜ï¼š</strong><br>
                        â€¢ "å“ªä¸ªå…¬å¸è´­ä¹°é‡‘é¢æœ€é«˜ï¼Ÿ"<br>
                        â€¢ "å“ªä¸ªæ´»åŠ¨æ•ˆæœæœ€å¥½ï¼Ÿ"<br>
                        â€¢ "æœ€ç•…é”€çš„äº§å“æ˜¯ä»€ä¹ˆï¼Ÿ"<br>
                        â€¢ "æ€»é”€å”®é¢æ˜¯å¤šå°‘ï¼Ÿ"<br>
                        â€¢ "å¹³å‡è½¬åŒ–ç‡æ˜¯å¤šå°‘ï¼Ÿ"<br><br>
                        ğŸ”— <strong>å…³è”æŸ¥è¯¢é—®é¢˜ï¼š</strong><br>
                        â€¢ "è…¾è®¯ç§‘æŠ€å‚åŠ äº†å“ªäº›æ´»åŠ¨ï¼Ÿ"<br>
                        â€¢ "æ–°å¹´è¥é”€å³°ä¼šè§¦è¾¾äº†å“ªäº›å…¬å¸ï¼Ÿ"<br>
                        â€¢ "å“ªäº›å…¬å¸è´­ä¹°äº†ä¼ä¸šç‰ˆCRMï¼Ÿ"<br>
                        â€¢ "è…¾è®¯ç§‘æŠ€åœ¨æ–°å¹´è¥é”€å³°ä¼šè´­ä¹°äº†ä»€ä¹ˆï¼Ÿ"<br><br>
                        ğŸ“ <strong>æç¤ºï¼š</strong>æ‚¨å¯ä»¥ç›´æ¥è¯¢é—®å…·ä½“çš„å…¬å¸åã€æ´»åŠ¨åæˆ–äº§å“å
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
